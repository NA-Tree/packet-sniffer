from scapy.all import sniff, IP, TCP, UDP, DNS, Raw
import threading
import sys
import time

class PacketSniffer:
    def __init__(self, interface=None):
        self.interface = interface
        self.running = False
        self.thread = None

        # Filters
        self.filter_proto = None
        self.filter_src = None
        self.filter_dst = None
        self.filter_port = None

        self.packet_count = 0
        self.captured_packets = []   # Store all packets for details view

    def set_filters(self):
        print("\n--- Packet Filter Setup (Press Enter to skip a filter) ---")

        proto = input("Protocol (tcp / udp / dns) : ").strip().lower()
        src_ip = input("Source IP filter : ").strip()
        dst_ip = input("Destination IP filter : ").strip()
        port = input("Port filter : ").strip()

        self.filter_proto = proto if proto else None
        self.filter_src = src_ip if src_ip else None
        self.filter_dst = dst_ip if dst_ip else None
        self.filter_port = int(port) if port.isdigit() else None

        print("\nFilters set. Starting sniff...\n")

    def filter_packet(self, pkt):
        """Apply user filters before displaying."""
        if IP in pkt:
            if self.filter_src and pkt[IP].src != self.filter_src:
                return False
            if self.filter_dst and pkt[IP].dst != self.filter_dst:
                return False

        if self.filter_proto:
            if self.filter_proto == "tcp" and TCP not in pkt:
                return False
            if self.filter_proto == "udp" and UDP not in pkt:
                return False
            if self.filter_proto == "dns" and DNS not in pkt:
                return False

        if self.filter_port:
            if TCP in pkt:
                if pkt[TCP].sport != self.filter_port and pkt[TCP].dport != self.filter_port:
                    return False
            if UDP in pkt:
                if pkt[UDP].sport != self.filter_port and pkt[UDP].dport != self.filter_port:
                    return False

        return True

    def analyze_packet(self, pkt):
        """Print readable packet data + store it."""
        self.packet_count += 1
        self.captured_packets.append(pkt)

        # Basic info
        src = pkt[IP].src if IP in pkt else "N/A"
        dst = pkt[IP].dst if IP in pkt else "N/A"

        print(f"[{self.packet_count}] {src} -> {dst}", end=" ")

        # TCP / UDP
        if TCP in pkt:
            print(f"(TCP {pkt[TCP].sport} → {pkt[TCP].dport})", end=" ")

        elif UDP in pkt:
            print(f"(UDP {pkt[UDP].sport} → {pkt[UDP].dport})", end=" ")

        # DNS parsing
        if DNS in pkt and pkt[DNS].qd:
            try:
                query = pkt[DNS].qd.qname.decode()
                print(f"[DNS Query: {query}]", end=" ")
            except:
                pass

        # Basic HTTP detection
        if TCP in pkt and Raw in pkt:
            payload = pkt[Raw].load
            try:
                text = payload.decode(errors="ignore")
                if "HTTP" in text or "GET " in text:
                    print(f"[HTTP] {text.splitlines()[0]}", end=" ")
            except:
                pass

        print()  # newline

    def show_packet_details(self):
        """Wireshark-style detail viewer."""
        print("\n=== PACKET DETAILS MODE ===")
        print("Enter a packet number to inspect, or 'q' to exit.\n")

        while True:
            user = input("Packet #: ").strip()

            if user.lower() == "q":
                print("Exiting details mode.\n")
                return

            if not user.isdigit():
                print("Invalid entry.")
                continue

            pkt_num = int(user)

            if pkt_num < 1 or pkt_num > len(self.captured_packets):
                print("Packet number not found.")
                continue

            pkt = self.captured_packets[pkt_num - 1]

            print("\n============================")
            print(f" FULL PACKET DETAILS ({pkt_num})")
            print("============================\n")
            pkt.show()     #   full Wireshark-style breakdown
            print("============================\n")

    def _sniff_loop(self):
        """Threaded sniffing loop."""
        def process(pkt):
            if self.filter_packet(pkt):
                self.analyze_packet(pkt)

        sniff(iface=self.interface, prn=process, store=False)

    def start(self):
        self.set_filters()
        print("\nStarting capture... Press CTRL+C to stop.")
        print("Type 'd' anytime to view packet details.\n")

        self.thread = threading.Thread(target=self._sniff_loop)
        self.thread.daemon = True
        self.thread.start()

        try:
            while True:
                cmd = input("").strip().lower()
                if cmd == "d":
                    self.show_packet_details()

        except KeyboardInterrupt:
            print("\nStopping sniff...")
            sys.exit(0)


if __name__ == "__main__":
    print("=== Mini Wireshark: Live Packet Sniffer ===")
    iface = input("Enter network interface (Press Enter for default): ").strip()
    iface = iface if iface else None

    sniffer = PacketSniffer(interface=iface)
    sniffer.start()
